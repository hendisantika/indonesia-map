name: Deploy to Dev Server

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag'
        required: false
        default: '16'

env:
  DOCKER_USERNAME: hendisantika
  DOCKER_IMAGE_NAME: indonesia-map
  DEV_SERVER_HOST: 103.31.204.189
  DEV_SERVER_USER: mhdcdev
  DEV_SERVER_PORT: 22
  CONTAINER_NAME: indonesia-map
  APP_PORT: 2000

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}

    steps:
      # Note: LFS disabled to avoid bandwidth quota issues
      # Migration files are included in the Maven build from src/main/resources
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B clean package -DskipTests -Dmaven.test.skip=true --file pom.xml

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Determine image tag
        id: meta
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="16"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Using tag: ${TAG}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy:
    name: Deploy to Dev Server
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ env.DEV_SERVER_PORT }} ${{ env.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Clean failed migrations on database
        run: |
          ssh -p ${{ env.DEV_SERVER_PORT }} ${{ env.DEV_SERVER_USER }}@${{ env.DEV_SERVER_HOST }} << 'EOF'
            echo "üßπ Cleaning failed migrations..."
            mysql -h ${{ env.DEV_SERVER_HOST }} -udeployer -p'${{ secrets.DB_PASSWORD }}' wilayah_indo \
              -e "DELETE FROM flyway_schema_history WHERE success = 0;" 2>/dev/null || echo "No failed migrations"
            echo "‚úÖ Database cleanup complete"
          EOF

      - name: Deploy to Dev Server
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        run: |
          ssh -p ${{ env.DEV_SERVER_PORT }} ${{ env.DEV_SERVER_USER }}@${{ env.DEV_SERVER_HOST }} << 'EOF'
            set -e

            echo "üöÄ Starting deployment..."

            # Configuration
            IMAGE="${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            PORT="${{ env.APP_PORT }}"
            DB_HOST="${{ env.DEV_SERVER_HOST }}"
            DB_URL="jdbc:mysql://${DB_HOST}:3306/wilayah_indo?createDatabaseIfNotExist=true&useUnicode=true&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=Asia/Jakarta&useSSL=false&allowPublicKeyRetrieval=true"

            echo "üìã Configuration:"
            echo "  - Image: ${IMAGE}"
            echo "  - Container: ${CONTAINER_NAME}"
            echo "  - Port: ${PORT}"
            echo "  - Database: ${DB_HOST}:3306/wilayah_indo"

            # Login to Docker Hub
            echo "üîê Logging in to Docker Hub..."
            echo "${{ secrets.DOCKER_TOKEN }}" | docker login --username ${{ env.DOCKER_USERNAME }} --password-stdin

            # Stop old container
            echo "üõë Stopping old container..."
            docker stop ${CONTAINER_NAME} 2>/dev/null || true
            docker rm ${CONTAINER_NAME} 2>/dev/null || true

            # Pull new image
            echo "üì• Pulling new image..."
            docker pull ${IMAGE}

            # Start new container
            echo "üé¨ Starting new container..."
            docker run -d \
              --name ${CONTAINER_NAME} \
              --restart unless-stopped \
              -p ${PORT}:${PORT} \
              -e SPRING_PROFILES_ACTIVE=dev \
              -e DB_URL="${DB_URL}" \
              -e DB_USERNAME=deployer \
              -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
              -e SERVER_PORT=${PORT} \
              ${IMAGE}

            echo "‚úÖ Container started!"

            # Wait for startup
            echo "‚è≥ Waiting for application to initialize..."
            sleep 15

            # Show status
            echo ""
            echo "üìä Container Status:"
            docker ps | grep ${CONTAINER_NAME} || echo "‚ùå Container not running!"

            echo ""
            echo "üìù Initial logs:"
            docker logs --tail 30 ${CONTAINER_NAME}

            echo ""
            echo "=========================================="
            echo "‚úÖ Deployment Complete!"
            echo "=========================================="
            echo ""
            echo "üåê Application: http://${DB_HOST}:${PORT}"
            echo "üè• Health Check: http://${DB_HOST}:${PORT}/actuator/health"
            echo ""
            echo "üìñ Monitor migrations:"
            echo "  docker logs -f ${CONTAINER_NAME} | grep -E 'Migrating|Successfully'"

          EOF

      - name: Verify deployment
        run: |
          ssh -p ${{ env.DEV_SERVER_PORT }} ${{ env.DEV_SERVER_USER }}@${{ env.DEV_SERVER_HOST }} << 'EOF'
            echo "üîç Verifying deployment..."

            # Check if container is running
            if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
              echo "‚úÖ Container is running"
            else
              echo "‚ùå Container is not running"
              exit 1
            fi

            # Wait a bit more for app to start
            sleep 10

            # Check health endpoint
            if curl -f -s http://localhost:${{ env.APP_PORT }}/actuator/health > /dev/null; then
              echo "‚úÖ Health check passed"
            else
              echo "‚è≥ Application still starting (migrations in progress)..."
              echo "   This is normal - migrations take 10-15 minutes"
            fi
          EOF

      - name: Deployment summary
        if: success()
        run: |
          echo "## üöÄ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ env.DEV_SERVER_HOST }}:${{ env.APP_PORT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access:**" >> $GITHUB_STEP_SUMMARY
          echo "- Application: http://${{ env.DEV_SERVER_HOST }}:${{ env.APP_PORT }}" >> $GITHUB_STEP_SUMMARY
          echo "- Health: http://${{ env.DEV_SERVER_HOST }}:${{ env.APP_PORT }}/actuator/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚è≥ **Note:** Flyway migrations take 10-15 minutes to complete" >> $GITHUB_STEP_SUMMARY
